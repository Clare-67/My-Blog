---
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Sidebar from "@/components/Sidebar.astro";
import { SITE } from "@/config";
import getSortedPosts from "@/utils/getSortedPosts";
import { getPath } from "@/utils/getPath";

const posts = await getCollection("blog");
const sortedPosts = getSortedPosts(posts);

const postResult = sortedPosts.reduce((acc, post) => {
  const year = post.data.pubDatetime.getFullYear();
  if (!acc[year]) {
    acc[year] = [];
  }
  acc[year].push(post);
  return acc;
}, {} as Record<number, typeof posts>);
---

<Layout>
  <Header />
  <main
    id="main-content"
    class="mx-auto grid max-w-app grid-cols-1 gap-x-0 px-4 pb-8 lg:grid-cols-12"
  >
    <div class="lg:col-span-9 lg:pr-8">
      <h1 class="mb-8 text-3xl font-semibold">归档</h1>
      <div class="prose">
        {
          Object.keys(postResult)
            .sort((a, b) => Number(b) - Number(a))
            .map(year => (
              <>
                <h2 class="year">{year}</h2>
                <ul>
                  {postResult[year].map(post => (
                    <li>
                      <a href={getPath(post.id, post.filePath)}>
                        {post.data.title}
                      </a>
                      &nbsp;&nbsp;&nbsp;
                      <span class="date">
                        {new Date(post.data.pubDatetime).toLocaleDateString(
                          "zh-CN",
                          {
                            month: "2-digit",
                            day: "2-digit",
                          }
                        )}
                      </span>
                    </li>
                  ))}
                </ul>
              </>
            ))
        }
      </div>
    </div>
    <div class="lg:col-span-3">
      <Sidebar />
    </div>
  </main>
  <Footer />
</Layout>
